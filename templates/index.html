<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accessories Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
    .container{max-width:1400px;margin:0 auto}
    .header{text-align:center;color:#fff;margin-bottom:30px}
    .header h1{font-size:2.5em;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .header p{font-size:1.1em;opacity:.9}
    .dashboard-wrapper{background:#fff;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.2);padding:30px}
    .filters-section{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);padding:25px;border-radius:12px;margin-bottom:30px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .filters-title{font-size:1.3em;color:#333;margin-bottom:20px;font-weight:600}
    .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px}
    .filter-group{display:flex;flex-direction:column}
    .filter-group label{font-weight:600;margin-bottom:8px;color:#333;font-size:.95em}
    .filter-group select{padding:12px 15px;border:2px solid #667eea;border-radius:8px;font-size:.95em;background:#fff;cursor:pointer}
    .button-group{display:flex;gap:12px;flex-wrap:wrap}
    .btn{padding:12px 25px;border:none;border-radius:8px;font-size:.95em;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;flex:1;min-width:150px;transition:transform .2s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .btn-secondary{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff}
    .btn-reset{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff}
    .error,.success{padding:15px;border-radius:8px;margin-bottom:20px;display:none}
    .error.show{display:block;background:#ffebee;color:#c62828;border-left:4px solid #c62828}
    .success.show{display:block;background:#e8f5e9;color:#2e7d32;border-left:4px solid #2e7d32}
    .loading{display:none;text-align:center;padding:20px}
    .loading.show{display:block}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .stats-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:10px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .stat-card h3{font-size:.85em;opacity:.9;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
    .stat-card .value{font-size:1.6em;font-weight:700}
    .charts-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:30px;margin-bottom:30px}
    .chart-container{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .chart-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:20px}
    .chart-filters{display:flex;gap:12px;flex-wrap:wrap}
    .chart-filters select{padding:8px 12px;border:2px solid #667eea;border-radius:6px;background:#fff;cursor:pointer}
    .chart-series-selector{display:flex;gap:20px;margin-bottom:15px;flex-wrap:wrap}
    .chart-series-selector label{display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;font-size:.95em}
    .chart-series-selector input{width:18px;height:18px;accent-color:#667eea}
    .table-wrapper{overflow-x:auto;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse;background:#fff}
    thead{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    th{padding:15px;text-align:left;font-weight:600;font-size:.9em;text-transform:uppercase;letter-spacing:.5px}
    td{padding:12px 15px;border-bottom:1px solid #e0e0e0}
    tbody tr:hover{background:#f5f5f5}
    .totals-row{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);font-weight:700}
    @media(max-width:768px){
      body{padding:12px}
      .header h1{font-size:1.8em}
      .filters-grid{grid-template-columns:1fr}
      .button-group{flex-direction:column}
      .stats-section{grid-template-columns:1fr}
      .charts-section{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Accessories Sales Dashboard</h1>
    <p>Real-time Sales Analytics and Reporting</p>
  </div>

  <div class="dashboard-wrapper">
    <div class="filters-section">
      <div class="filters-title">Filter Data</div>

      <div class="filters-grid">
        <div class="filter-group">
          <label for="quarter">Fiscal Quarter</label>
          <select id="quarter"><option value="">All Quarters</option></select>
        </div>

        <div class="filter-group">
          <label for="month">Fiscal Month</label>
          <select id="month"><option value="">All Months</option></select>
        </div>

        <div class="filter-group">
          <label for="location">Division/Location</label>
          <select id="location"><option value="">All Divisions</option></select>
        </div>

        <div class="filter-group">
          <label for="model">Model Group</label>
          <select id="model"><option value="">All Models</option></select>
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn btn-secondary" onclick="exportToExcel()">Export to Excel</button>
        <button class="btn btn-reset" onclick="resetFilters()">Reset Filters</button>
      </div>
    </div>

    <div class="error" id="error"></div>
    <div class="success" id="success"></div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>Loading data...</div>
    </div>

    <div class="stats-section" id="stats"></div>

    <div class="charts-section">
      <div class="chart-container">
        <div class="chart-header">
          <h3>Sales Trend Analysis</h3>
          <div class="chart-filters">
            <select id="chartType">
              <option value="month">Month Wise</option>
              <option value="quarter">Quarter Wise</option>
            </select>
            <select id="priceModel">
              <option value="gndp">GNDP</option>
              <option value="mrp">MRP</option>
            </select>
          </div>
        </div>

        <div class="chart-series-selector">
          <label><input type="checkbox" id="showROs" checked>ROs Sale</label>
          <label><input type="checkbox" id="showCounter" checked>Counter Sale</label>
          <label><input type="checkbox" id="showTotal" checked>Total Sale</label>
        </div>

        <canvas id="salesChart"></canvas>
      </div>
    </div>

    <div class="data-section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <div style="font-size:1.3em;font-weight:600;">Sales Data</div>
        <div id="recordCount" style="color:#666;font-size:.9em;"></div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>Fiscal Quarter</th>
            <th>Fiscal Month</th>
            <th>Location</th>
            <th>Model Group</th>
            <th>Billied ROs</th>
            <th>ROs Sale GNDP</th>
            <th>ROs Sale MRP</th>
            <th>Counter ROs</th>
            <th>Counter Sale GNDP</th>
            <th>Counter Sale MRP</th>
            <th>Revenue GNDP per RO</th>
            <th>Revenue MRP per RO</th>
          </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  let allData = [];
  let chartInstance = null;
  let isLoadingData = false;

  const qEl = document.getElementById('quarter');
  const mEl = document.getElementById('month');
  const lEl = document.getElementById('location');
  const mdEl = document.getElementById('model');

  const chartTypeEl = document.getElementById('chartType');
  const priceModelEl = document.getElementById('priceModel');

  chartTypeEl.addEventListener('change', updateChart);
  priceModelEl.addEventListener('change', updateChart);
  document.getElementById('showROs').addEventListener('change', updateChart);
  document.getElementById('showCounter').addEventListener('change', updateChart);
  document.getElementById('showTotal').addEventListener('change', updateChart);

  document.addEventListener('DOMContentLoaded', async () => {
    await loadFilterOptions();
    await applyFilters();
  });

  async function loadFilterOptions(){
    try{
      const res = await fetch('/api/filter-options');
      const opt = await res.json();
      populateSelect('quarter', opt.quarters);
      populateSelect('month', opt.months);
      populateSelect('location', opt.locations);
      populateSelect('model', opt.models);
    }catch(e){
      showError('Failed to load filter options: ' + e.message);
    }
  }

  function populateSelect(id, items){
    const s = document.getElementById(id);
    items.forEach(v=>{
      const o=document.createElement('option');
      o.value=v; o.textContent=v;
      s.appendChild(o);
    });
  }

  async function applyFilters(){
    if(isLoadingData) return;
    isLoadingData = true;

    showLoading(true);
    hideMessages();

    const payload = {
      quarter: qEl.value,
      month: mEl.value,
      location: lEl.value,
      model: mdEl.value
    };

    try{
      const res = await fetch('/api/get-data',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if(!res.ok) throw new Error('Failed to fetch data');

      const result = await res.json();
      allData = result.data || [];

      displayData(result.data, result.totals, result.count);
      displayStats(result.totals);
      updateChart();

      showSuccess('Data loaded successfully');
    }catch(e){
      showError('Error loading data: ' + e.message);
    }finally{
      showLoading(false);
      isLoadingData = false;
    }
  }

  function resetFilters(){
    qEl.value=''; mEl.value=''; lEl.value=''; mdEl.value='';
    applyFilters();
  }

  function displayStats(t){
    const box=document.getElementById('stats');
    box.innerHTML='';

    const items=[
      {label:'Total Billied ROs', value: formatNumber(t['No of Billied Ros'],0)},
      {label:'Total ROs Sale GNDP', value:'Rs '+formatNumber(t['Acc Sale throughROs (GNDP)In Rs'],0)},
      {label:'Total ROs Sale MRP', value:'Rs '+formatNumber(t['Acc Sale throughROs (MRP) In Rs'],0)},
      {label:'Total Counter ROs', value: formatNumber(t['No of Counter ROs'],0)},
      {label:'Counter Sale GNDP', value:'Rs '+formatNumber(t['Acc Sale throughCounter (GNDP) In Rs'],0)},
      {label:'Counter Sale MRP', value:'Rs '+formatNumber(t['Acc Sale throughCounter (MRP) In Rs'],0)},
    ];

    items.forEach(s=>{
      const d=document.createElement('div');
      d.className='stat-card';
      d.innerHTML=`<h3>${s.label}</h3><div class="value">${s.value}</div>`;
      box.appendChild(d);
    });
  }

  function displayData(data, totals, count){
    const tbody=document.getElementById('tableBody');
    tbody.innerHTML='';

    if(!data || data.length===0){
      tbody.innerHTML='<tr><td colspan="12" style="text-align:center;padding:40px;color:#999;">No data found</td></tr>';
      document.getElementById('recordCount').textContent='';
      return;
    }

    data.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${safe(r['Fiscal Quarter'])}</td>
        <td>${safe(r['Fiscal Month'])}</td>
        <td>${safe(r['Location'])}</td>
        <td>${safe(r['Model Group'])}</td>
        <td>${formatNumber(r['No of Billied Ros'],0)}</td>
        <td>Rs ${formatNumber(r['Acc Sale throughROs (GNDP)In Rs'],0)}</td>
        <td>Rs ${formatNumber(r['Acc Sale throughROs (MRP) In Rs'],0)}</td>
        <td>${formatNumber(r['No of Counter ROs'],0)}</td>
        <td>Rs ${formatNumber(r['Acc Sale throughCounter (GNDP) In Rs'],0)}</td>
        <td>Rs ${formatNumber(r['Acc Sale throughCounter (MRP) In Rs'],0)}</td>
        <td>Rs ${formatNumber(r['Acc Revenue (GNDP) / RO'],0)}</td>
        <td>Rs ${formatNumber(r['Acc Revenue (MRP) / RO'],0)}</td>
      `;
      tbody.appendChild(tr);
    });

    const ttr=document.createElement('tr');
    ttr.className='totals-row';
    ttr.innerHTML=`
      <td colspan="4">TOTAL</td>
      <td>${formatNumber(totals['No of Billied Ros'],0)}</td>
      <td>Rs ${formatNumber(totals['Acc Sale throughROs (GNDP)In Rs'],0)}</td>
      <td>Rs ${formatNumber(totals['Acc Sale throughROs (MRP) In Rs'],0)}</td>
      <td>${formatNumber(totals['No of Counter ROs'],0)}</td>
      <td>Rs ${formatNumber(totals['Acc Sale throughCounter (GNDP) In Rs'],0)}</td>
      <td>Rs ${formatNumber(totals['Acc Sale throughCounter (MRP) In Rs'],0)}</td>
      <td>Rs ${formatNumber(totals['Acc Revenue (GNDP) / RO'],0)}</td>
      <td>Rs ${formatNumber(totals['Acc Revenue (MRP) / RO'],0)}</td>
    `;
    tbody.appendChild(ttr);

    document.getElementById('recordCount').textContent = `Showing ${count} records`;
  }

  function updateChart(){
    const chartType=chartTypeEl.value;
    const priceModel=priceModelEl.value;

    if(chartType==='month') createMonthWiseChart(priceModel);
    else createQuarterWiseChart(priceModel);
  }

  function createMonthWiseChart(priceModel){
    const order=['Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb','Mar'];
    const mdata={};

    allData.forEach(r=>{
      const m=r['Fiscal Month'];
      if(!mdata[m]) mdata[m]={ros_gndp:0,ros_mrp:0,counter_gndp:0,counter_mrp:0};
      mdata[m].ros_gndp += (+r['Acc Sale throughROs (GNDP)In Rs'] || 0);
      mdata[m].ros_mrp += (+r['Acc Sale throughROs (MRP) In Rs'] || 0);
      mdata[m].counter_gndp += (+r['Acc Sale throughCounter (GNDP) In Rs'] || 0);
      mdata[m].counter_mrp += (+r['Acc Sale throughCounter (MRP) In Rs'] || 0);
    });

    const labels = order.filter(x=>mdata[x]);
    const ros = labels.map(x=> priceModel==='gndp' ? mdata[x].ros_gndp : mdata[x].ros_mrp);
    const counter = labels.map(x=> priceModel==='gndp' ? mdata[x].counter_gndp : mdata[x].counter_mrp);
    const total = labels.map((_,i)=> ros[i] + counter[i]);

    drawChart(labels, ros, counter, total, `Month Wise Sales Trend ${priceModel.toUpperCase()}`);
  }

  function createQuarterWiseChart(priceModel){
    const order=['Q1','Q2','Q3','Q4'];
    const qdata={};

    allData.forEach(r=>{
      const q=r['Fiscal Quarter'];
      if(!qdata[q]) qdata[q]={ros_gndp:0,ros_mrp:0,counter_gndp:0,counter_mrp:0};
      qdata[q].ros_gndp += (+r['Acc Sale throughROs (GNDP)In Rs'] || 0);
      qdata[q].ros_mrp += (+r['Acc Sale throughROs (MRP) In Rs'] || 0);
      qdata[q].counter_gndp += (+r['Acc Sale throughCounter (GNDP) In Rs'] || 0);
      qdata[q].counter_mrp += (+r['Acc Sale throughCounter (MRP) In Rs'] || 0);
    });

    const labels = order.filter(x=>qdata[x]);
    const ros = labels.map(x=> priceModel==='gndp' ? qdata[x].ros_gndp : qdata[x].ros_mrp);
    const counter = labels.map(x=> priceModel==='gndp' ? qdata[x].counter_gndp : qdata[x].counter_mrp);
    const total = labels.map((_,i)=> ros[i] + counter[i]);

    drawChart(labels, ros, counter, total, `Quarter Wise Sales Trend ${priceModel.toUpperCase()}`);
  }

  // chart stable (no enlarge/hang)
  function drawChart(labels, ros, counter, total, title){
    const canvas=document.getElementById('salesChart');
    const ctx=canvas.getContext('2d');

    canvas.height = 320;
    canvas.width = canvas.parentElement.clientWidth;

    if(chartInstance){
      chartInstance.destroy();
      chartInstance=null;
    }

    const datasets=[];
    if(document.getElementById('showROs').checked) datasets.push({label:'ROs Sale', data:ros, borderWidth:2, tension:.3});
    if(document.getElementById('showCounter').checked) datasets.push({label:'Counter Sale', data:counter, borderWidth:2, tension:.3});
    if(document.getElementById('showTotal').checked) datasets.push({label:'Total Sale', data:total, borderWidth:2, tension:.3});

    chartInstance=new Chart(ctx,{
      type:'line',
      data:{labels:labels, datasets:datasets},
      options:{
        responsive:false,
        animation:false,
        maintainAspectRatio:false,
        plugins:{
          title:{display:true, text:title},
          legend:{display:true}
        },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  }

  async function exportToExcel(){
    try{
      const payload = {
        quarter: qEl.value,
        month: mEl.value,
        location: lEl.value,
        model: mdEl.value
      };

      const res = await fetch('/api/export-excel',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if(!res.ok) throw new Error('Export failed');

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'accessories_sales_filtered.xlsx';
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      showSuccess('File exported successfully');
    }catch(e){
      showError('Export failed: ' + e.message);
    }
  }

  function safe(v){ return (v===undefined || v===null) ? '' : v; }
  function formatNumber(num,decimals=0){
    const n=Number(num);
    if(!isFinite(n)) return '0';
    return n.toLocaleString('en-IN',{minimumFractionDigits:decimals,maximumFractionDigits:decimals});
  }
  function showLoading(b){ document.getElementById('loading').classList.toggle('show',!!b); }
  function showError(msg){ const d=document.getElementById('error'); d.textContent=msg; d.classList.add('show'); }
  function showSuccess(msg){ const d=document.getElementById('success'); d.textContent=msg; d.classList.add('show'); setTimeout(()=>d.classList.remove('show'),2500); }
  function hideMessages(){ document.getElementById('error').classList.remove('show'); document.getElementById('success').classList.remove('show'); }
</script>
</body>
</html>
